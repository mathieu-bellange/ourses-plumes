<!doctype html>
<html lang="fr">
	<head>
		<script src="boot.js"></script>
	</head>
	<body>

		<script>
			var agenda_edit = true;
			var loax_pool = {
				"agenda_view_mptl" : $loc.tmpl + "agenda-view.mptl",
				"agenda_edit_mptl" : $loc.tmpl + "agenda-edit.mptl"
			};
		</script>

		<div id="dev_container">

			<h2 class="red">Agenda <small>.date-table</small></h2>

			<!--Agenda-->
			<section id="agenda">
				<!--Date Switcher-->
				<div class="date-switcher">
					<h3>&nbsp;</h3>
					<a href="javascript:void(0)" class="prev icon-left" title="Pr&eacute;c&eacute;dent"></a>
					<a href="javascript:void(0)" class="next icon-right" title="Suivant"></a>
				</div>
				<!--Date Table-->
				<table class="date-table">
					<thead>
						<tr>
							<th>Lun<span class="date-name-suffix">di</span></th>
							<th>Mar<span class="date-name-suffix">di</span></th>
							<th>Mer<span class="date-name-suffix">credi</span></th>
							<th>Jeu<span class="date-name-suffix">di</span></th>
							<th>Ven<span class="date-name-suffix">dredi</span></th>
							<th>Sam<span class="date-name-suffix">edi</span></th>
							<th>Dim<span class="date-name-suffix">anche</span></th>
						</tr>
					</thead>
					<tbody>
					<!--
						<tr>
							<td></td>
							<td><div class="over-block"><time datetime="2014-07-01">1</time><a class="over" href="javascript:void(0)" title="Ajouter un &eacute;v&egrave;nement &agrave; cette date"></a></div></td>
							<td>
								<div class="over-block has-event">
									<time datetime="2014-07-02">2</time>
									<ul class="event-list hide">
										<li><strong class="title">Colloque</strong><span class="hide">&#8201;: </span><span class="text hide">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Cras fringilla sem vitae justo aliquet, semper tempus quam scelerisque. Maecenas quis neque urna. Donec ut iaculis magna. Sed fermentum, leo at sodales pellentesque, ante nibh pharetra mauris metus.</span></li>
										<li><strong class="title">Expo</strong></li>
										<li><strong class="title"></strong></li>
										<li></li>
										<li><strong class="title">D&eacute;bat public</strong><span class="hide">&#8201;: </span><span class="text hide">&nbsp;</span></li>
										<li><strong class="title"><del>Manif</del></strong><span class="hide">&#8201;: </span><span class="text hide">Annulé !</span></li>
										<li><strong class="title">Concert</strong><span class="hide">&#8201;: </span><span class="text hide">C'est à 22 heures !</span></li>
									</ul>
									<a class="over" href="javascript:void(0)" title="Voir les &eacute;v&egrave;nements &agrave; cette date"></a>
								</div>
							</td>
							<td>
								<div class="over-block has-event">
									<time datetime="2014-07-03">3</time>
									<ul class="event-list hide">
										<li><strong class="title">Ap&eacute;ro g&eacute;ant</strong></li>
									</ul>
									<a class="over" href="javascript:void(0)" title="Voir les &eacute;v&egrave;nements &agrave; cette date"></a>
								</div>
							</td>
							<td><div class="over-block"><time datetime="2014-07-04">4</time><a class="over" href="javascript:void(0)" title="Ajouter un &eacute;v&egrave;nement &agrave; cette date"></a></div></td>
							<td><div class="over-block"><time datetime="2014-07-05">5</time></div></td>
							<td><div class="over-block"><time datetime="2014-07-06">6</time></div></td>
						</tr>
						<tr>
							<td><div class="over-block"><time datetime="2014-07-07">7</time></div></td>
							<td><div class="over-block"><time datetime="2014-07-08">8</time></div></td>
							<td><div class="over-block"><time datetime="2014-07-09">9</time></div></td>
							<td><div class="over-block"><time datetime="2014-07-10">10</time></div></td>
							<td><div class="over-block"><time datetime="2014-07-11">11</time></div></td>
							<td><div class="over-block"><time datetime="2014-07-12">12</time></div></td>
							<td><div class="over-block"><time datetime="2014-07-13">13</time></div></td>
						</tr>
						<tr>
							<td>
								<div class="over-block has-event">
									<time datetime="2014-07-14">14</time>
									<ul class="event-list hide">
										<li><strong class="title">F&ecirc;te nationale</strong></li>
									</ul>
									<a class="over" href="javascript:void(0)" title="Voir les &eacute;v&egrave;nements &agrave; cette date"></a>
								</div>
							</td>
							<td><div class="over-block"><time datetime="2014-07-15">15</time></div></td>
							<td><div class="over-block"><time datetime="2014-07-16">16</time></div></td>
							<td><div class="over-block"><time datetime="2014-07-17">17</time></div></td>
							<td><div class="over-block"><time datetime="2014-07-18">18</time></div></td>
							<td><div class="over-block"><time datetime="2014-07-19">19</time></div></td>
							<td><div class="over-block"><time datetime="2014-07-20">20</time></div></td>
						</tr>
						<tr>
							<td><div class="over-block"><time datetime="2014-07-21">21</time></div></td>
							<td><div class="over-block"><time datetime="2014-07-22">22</time></div></td>
							<td><div class="over-block"><time datetime="2014-07-23">23</time></div></td>
							<td><div class="over-block"><time datetime="2014-07-24">24</time></div></td>
							<td><div class="over-block"><time datetime="2014-07-25">25</time></div></td>
							<td><div class="over-block"><time datetime="2014-07-26">26</time></div></td>
							<td><div class="over-block"><time datetime="2014-07-27">27</time></div></td>
						</tr>
						<tr>
							<td><div class="over-block"><time datetime="2014-07-28">28</time></div></td>
							<td><div class="over-block"><time datetime="2014-07-29">29</time></div></td>
							<td><div class="over-block"><time datetime="2014-07-30">30</time></div></td>
							<td>
								<div class="over-block has-event">
									<time datetime="2014-07-31">31</time>
									<ul class="event-list hide">
										<li>Marche des fiert&eacute;s</li>
										<li>Anniv Popi</li>
									</ul>
									<a class="over" href="javascript:void(0)" title="Voir les &eacute;v&egrave;nements &agrave; cette date"></a>
								</div>
							</td>
							<td></td>
							<td></td>
							<td></td>
						</tr>
						-->
					</tbody>
				</table>
			</section>
		</div>

		<script>
			/*
			$(document).ready(function() {
				// variables
				var today = new Date();
				var m = today.getMonth();
				var y = today.getFullYear();
				var db = [{
						"day" : 1415660400000,
						"events" : [{
								"id" : 3,
								"title" : "Event 3 du 11/11/2014"
							}, {
								"id" : 2,
								"title" : "Event 2 du 11/11/2014"
							}
						]
					}, {
						"day" : 1412892000000,
						"events" : [{
								"id" : 1,
								"title" : "Event 1 du 10/10/2014"
							}
						]
					}, {
						"day" : 1424764728382,
						"events" : [{
								"id" : 7,
								"title" : "Event 7 du 24/02/2015",
								"description" : "Description de l'évènement."
							}
						]
					}, {
						"day" : 1417388400000,
						"events" : [{
								"id" : 4,
								"title" : "Event 4 du 01/12/2014"
							}
						]
					}, {
						"day" : 1420326000000,
						"events" : [{
								"id" : 6,
								"title" : "Event 6 du 04/01/2015"
							}, {
								"id" : 5,
								"title" : "Event 5 du 04/01/2015"
							}
						]
					}
				];
				// functions
				function build_calendar(year, month) {
					var q = new Date(year, month, 1); // first day in month
					var m = []; // month array
					var w = []; // week array
					var n = q.getDay();
					var i = 1; // num counter
					for (i; i < (n == 0 ? 7 : n); i++) {
						w.push({}); // fill first week gap with empty object
					} i = 1; // reset counter
					while (q.getMonth() === month) {
						var ymd = getDateTime(new Date(q));
						var d = {}; // day object in week array
						// set day object
						d.num = i;
						d.date = ymd;
						for (k in db) { // check date in db
							if (getDateTime(new Date(q)) == getDateTime(new Date(db[k].day))) {
								if (typeof(db[k].events) !== "undefined") {
									d.events = [];
									for (e in db[k].events) {
										var h = {};
										if (typeof(db[k].events[e].title) !== "undefined") {
											h.title = db[k].events[e].title; // get name
										}
										if (typeof(db[k].events[e].description) !== "undefined") {
											h.description = db[k].events[e].description; // get desc
										}
										d.events.push(h);
									}
								}
							}
						}
						// push week array
						w.push(d);
						// check week last day
						if (q.getDay() == 0) {
							m.push(w);
							w = []; // reset week array
						}
						// increment all
						q.setDate(q.getDate() + 1);
						i++;
					}
					// push last values
					var n = q.getDay();
					for (i = (n == 0 ? 7 : n); i <= 7; i++) {
						w.push({}); // fill last week gap with empty object
					}
					m.push(w); // push last week array
					return m; // return month array
				}
				function update_agenda(year, month) {
					$(".date-switcher h3").html($time.months[month].capitalize() + " " + year);
					$(".date-table tbody").html(file_pool.date_table_tmpl({"month" : build_calendar(y, m)})); // append table body
				}
				// process build
				update_agenda(y, m);
				// live events
				$(".date-switcher .prev").click(function() {
					if (m == 0) {m = 11; y -= 1;} else {m -= 1}
					update_agenda(y, m);
				});
				$(".date-switcher .next").click(function() {
					if (m == 11) {m = 0; y += 1;} else {m += 1}
					update_agenda(y, m);
				});
			});
			*/
		</script>

		<script>
		/*
		var agenda_ui = (function() {
			var cfg = {
				"fx_d"         : 375,            // [Int]  Duration of effects (ms). Default : 375
				"ev_t"         : 750,            // [Int]  Timeout before showing date events (ms). Default : 500
				"show_events"  : true,           // [Bool] Show sliding date events ? Default : true
				"template"     : function() {},  // [Func] Template function for compiling. Default : function() {}
				"on_open"      : function() {},  // [Func] Callback function before modal opening. Default : function() {}
				"on_close"     : function() {},  // [Func] Callback function before modal opening. Default : function() {}
				"on_opened"    : function() {},  // [Func] Callback function after modal opening. Default : function() {}
				"on_closed"    : function() {},  // [Func] Callback function after modal closing. Default : function() {}
			};
			return {
				init : function(opts) {
					cfg = $.extend({}, cfg, opts);
					$(document).on("mouseenter", ".has-event", function() {
						if (isComputer() && cfg.show_events) {
							var self = $(this);
							self.data("hover", true);
							setTimeout(function() {
								if (self.data("hover") == true) {
									self.css({"width" : self.outerWidth(), "position" : "absolute", "z-index" : "1"});
									self.children(".event-list").slideDown($conf.js_fx ? cfg.fx_d / 2 : 0);
								}
							}, cfg.ev_t);
						}
					});
					$(document).on("mouseleave", ".has-event", function() {
						if (isComputer() && cfg.show_events) {
							var self = $(this);
							self.data("hover", false);
							self.children(".event-list").slideUp($conf.js_fx ? cfg.fx_d : 0, function() {
								self.css({"width" : "", "position" : "", "z-index" : ""});
							});
						}
					});
					$(document).on("click", ".over", function() {
						if ($(".reveal-modal").is(":visible")) {
							if (!$("html").data("revealing-modal")) {
								$(".reveal-modal").foundation("reveal", "close");
							}
						} else {
							// Create modal
							var self = $(this);
							var p = self.parent();
							var e = [];
							p.find(".event-list").children("li").each(function() {
								var title = $(this).find(".title").html() || null;
								var text = $(this).find(".text").html() || null;
								if (title) {e.push({"title" : decode_html(title), "text" : (text ? decode_html(text, true) : null)})}
							});
							var d = p.find("time").first().attr("datetime") || 0;  // Datetime
							var a = d.split("-"); // YMD array
							var t = new Date(a[0], a[1] - 1, a[2]); // Timestamp
							var c = {
								"id"       : d,
								"date"     : $time.days[t.getDay() == 0 ? 6 : t.getDay() - 1].capitalize() + " " + dateToHTML(t),
								"events"   : e
							};
							var modal = $(cfg.template(c));
							// Append modal
							$("body").append(modal);
							// Reload SVG icons
							modal.svg_icons();
							// Remember caller
							modal.data("caller", self);
							// Bind events
							modal.on("open", function() {
								$("html").data("revealing-modal", true);
								cfg.on_open(); // callback
							});
							modal.on("close", function() {
								cfg.on_close(); // callback
							});
							modal.on("opened", function() {
								$("html").removeData("revealing-modal");
								cfg.on_opened(); // callback
							});
							modal.on("closed", function() {
								cfg.on_closed(); // callback
								self.focus(); // restore focus
								$(this).remove();
							});
							// Initialize modal
							modal.foundation("reveal", "open");
						}
					});
				}
			}
		}());
		*/
		</script>

		<script>

			//----------------------------------------------------------------
			// # Functions
			//----------------------------------------------------------------

			function remove_date_modal() {
				$("#date_modal").foundation("reveal", "close");
			}

			function remove_date_event(obj) {
				if ($("#date_modal").find("[data-delete]").size() == 1) {
					var c = $("#date_modal").data("caller").parent(".over-block");
					c.find(".event-list").remove(); // remove event list
					c.removeClass("has-event"); // remove has event class
					remove_date_modal() // remove modal
				}
				obj.nextAll(".title").first().next(".error").remove();
				obj.nextAll(".title").first().remove();
				obj.nextAll(".description").first().remove();
				obj.remove();
			}

			function delete_date_event(obj) {
				if ($conf.confirm_delete.date_event) {
					var modal_options = {
						"text" : $msg.confirm_delete.date_event,
						"class" : "panel radius",
						"on_confirm" : function() {
							remove_date_event(obj);
						}
					};
					$("body").create_confirmation_modal(modal_options);
				} else {
					remove_date_event(obj);
				}
			}

			function create_date_event() {
				$("#date_modal fieldset").append(file_pool.date_event_edit_tmpl({"title" : "", "text" : ""}));
				$("#date_modal").svg_icons();
				init_date_event();
			}

			function init_date_event() {
				$("#date_modal textarea").autosize(autosize_cfg); // initialize autosize plugin
				$("#date_modal textarea").add_confirmation_bar(); // add confirmation to textarea
			}

			function check_date_event() {
				var a = $("#date_modal .title");
				var b = $("#date_modal .description");
				// 1. Check fields validity
				a.check_validity();
				b.clean_value();
				// 2. Check form validity
				if (a.is_valid()) { // if all fields are valid
					var data = [];
					$("#date_modal .title").each(function() {
						data.push({
							"title" : encode_html($(this).val()),
							"description" : encode_html($(this).nextAll(".description").first().val(), true)
						});
					});
					send_date_event(data); // send data to db
				} else { // any field is invalid
					$("#date_modal").find("h2").first().create_alert_box($msg.form_invalid, "fail", {"timeout" : $time.duration.alert_long, "insert" : "after"}); // display form invalid alert
				}
			}

			function send_date_event(data) {
			//////////////////////////////////////////////////////////////////
			// 1. save data
			// 2. remove modal
			// 3. display success alert
			// 4. update date table with new values
			//////////////////////////////////////////////////////////////////
			// TODO : AJAX
			//////////////////////////////////////////////////////////////////
			// - on fail : display error alert
			// - on success : register output to db
			//////////////////////////////////////////////////////////////////
				alert("output : " + JSON.stringify(data));
			//////////////////////////////////////////////////////////////////
				remove_date_modal();
			//////////////////////////////////////////////////////////////////
				// $(".main-body").create_alert_box($msg.form_valid, null, {"class" : "success", "icon" : "info", "timeout" : $time.duration.alert}); // display form valid alert
				$("h2.red").create_alert_box($msg.form_valid, "success", {"class" : "success", "icon" : "info", "timeout" : $time.duration.alert}); // TEST only
			//////////////////////////////////////////////////////////////////
				var c = $("#date_modal").data("caller").parent(".over-block");
				var l = $(file_pool.date_event_list_tmpl({"events" : data}));
				if (!c.hasClass("has-event")) {c.addClass("has-event")}
				c.find(".event-list").remove(); // remove event list
				c.find(".over").before(l); // insert event list
			}

			//----------------------------------------------------------------
			// # Live events
			//----------------------------------------------------------------
			$(document)
				// Data Handling
				.on("click", "#date_modal [data-delete]", function() {delete_date_event($(this))}) // delete date event
				.on("click", "#date_modal .button-bar [data-add]", function() {create_date_event()}) // create date event
				.on("click", "#date_modal .button-bar [data-submit]", function() {check_date_event()}) // submit date modal
				.on("click", "#date_modal .button-bar [data-cancel]", function() {remove_date_modal()}); // cancel date modal

		</script>

		<script>
			$(document).ready(function() {
				var data = [{
						"day" : 1415660400000,
						"events" : [{
								"id" : 3,
								"title" : "Event 3 du 11/11/2014"
							}, {
								"id" : 2,
								"title" : "Event 2 du 11/11/2014"
							}
						]
					}, {
						"day" : 1412892000000,
						"events" : [{
								"id" : 1,
								"title" : "Event 1 du 10/10/2014"
							}
						]
					}, {
						"day" : 1424764728382,
						"events" : [{
								"id" : 7,
								"title" : "Event 7 du 24/02/2015",
								"description" : "Description de l'évènement."
							}
						]
					}, {
						"day" : 1417388400000,
						"events" : [{
								"id" : 4,
								"title" : "Event 4 du 01/12/2014"
							}
						]
					}, {
						"day" : 1420326000000,
						"events" : [{
								"id" : 6,
								"title" : "Event 6 du 04/01/2015"
							}, {
								"id" : 5,
								"title" : "Event 5 du 04/01/2015"
							}
						]
					}
				];
				agenda_ui.build(data)
				if (typeof(agenda_edit) !== 'undefined' && agenda_edit) {
					agenda_ui.init({
						"template" : function(arg) {
							return file_pool.date_modal_edit_tmpl(arg);
						},
						"on_open" : function() {
							$("#agenda").disable_tabnav();
						},
						"on_close" : function() {
							$("#agenda").renable_tabnav();
						},
						"on_opened" : function() {
							$("#date_modal").find(".close-reveal-modal").focus();
							init_date_event();
						},
						"on_closed" : function() {}
					});
				} else {
					agenda_ui.init({"template" : function(arg) {
						return file_pool.date_modal_tmpl(arg);
					}});
				}
			});
		</script>

		<script>
			$build.container = false;
			load();
		</script>
	</body>
</html>
